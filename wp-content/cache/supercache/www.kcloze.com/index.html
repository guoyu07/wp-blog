<!DOCTYPE html> <html class="no-js" lang="zh-CN" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#"> <head profile="http://gmpg.org/xfn/11"> <meta http-equiv="Content-type" content="text/html;charset=UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> <title>月随人</title> <meta name="description" content="kcloze&#039;s blog，月随人的技术博客，专注PHP,LAMP,Linux网站架构技术"/> <meta property="og:type" content="blog"/> <meta property="og:title" content="月随人"/> <meta property="og:description" content="专注PHP,LNMP,C,Linux网站架构技术"/> <meta property="og:url" content="http://www.kcloze.com/"/> <meta property="og:site_name" content="月随人"/> <meta name="twitter:card" content="summary"/> <script>document.documentElement.className = document.documentElement.className.replace("no-js","js");</script> <link rel="alternate" type="application/rss+xml" title="月随人 &raquo; Feed" href="feed/"/> <link rel="alternate" type="application/rss+xml" title="月随人 &raquo; 评论Feed" href="comments/feed/"/> <link rel='stylesheet' id='hoffman_genericons-css' href="wp-content/themes/hoffman/genericons/genericons.css?ver=4.1" type='text/css' media='all'/> <link rel='stylesheet' id='hoffman_style-css' href="wp-content/themes/hoffman/style.css?ver=4.1" type='text/css' media='all'/> <script type='text/javascript' src='http://cdn.staticfile.org/jquery/2.1.1/jquery.min.js?ver=2.1.0'></script> <link rel="EditURI" type="application/rsd+xml" title="RSD" href="xmlrpc.php?rsd"/> <link rel="wlwmanifest" type="application/wlwmanifest+xml" href="wp-includes/wlwmanifest.xml"/> <meta name="generator" content="WordPress 4.1"/> <style type="text/css"> body a { color:#928452; } body a:hover { color:#928452; } .blog-title a { color:#928452; } .main-menu > li > ul:before { border-bottom-color:#928452; } .main-menu ul li { background:#928452; } .main-menu ul > .page_item_has_children:hover::after { border-left-color:#928452; } .main-menu ul > .menu-item-has-children:hover::after { border-left-color:#928452; } .menu-social a:hover { background:#928452; } .sticky .is-sticky:hover { background:#928452; } .sticky .is-sticky:hover:before { border-top-color:#928452; } .sticky .is-sticky:hover:before { border-left-color:#928452; } .sticky .is-sticky:hover:after { border-left-color:#928452; } .sticky .is-sticky:hover:after { border-bottom-color:#928452; } .flex-direction-nav a:hover { background-color:#928452; } .post-quote cite { color:#928452; } a.post-quote:hover cite { border-bottom-color:#928452; } .post-title a:hover { color:#928452; } .post-header:after { background:#928452; } .post-content a { color:#928452; } .post-content a:hover { color:#928452; } .post-content a:hover { border-bottom-color:#928452; } .post-content a.more-link { border-color:#928452; } .post-content a.more-link:hover { background:#928452; } .post-content input[type="submit"]:hover { background-color:#928452; } .post-content input[type="reset"]:hover { background-color:#928452; } .post-content input[type="button"]:hover { background-color:#928452; } .post-content fieldset legend { background-color:#928452; } #infinite-handle span { color:#928452; } #infinite-handle span { border-color:#928452; } #infinite-handle span:hover { background:#928452; } .post-content .page-links a:hover { background:#928452; } .tab-selector a.active { color:#928452; } .tab-selector a.active { color:#928452; } .add-comment-title a { color:#928452; } .add-comment-title a:hover { color:#928452; } .bypostauthor .by-post-author { background-color:#928452; } .comment-actions a:hover { color:#928452; } .comment-actions a:hover:before { color:#928452; } .comment-header h4 a:hover { color:#928452; } .comment-content a { color:#928452; } .comment-content a:hover { color:#928452; } #cancel-comment-reply-link:hover { color:#928452; } .comments-nav a:hover { color:#928452; } .post-meta-item .genericon { color:#928452; } .post-meta-item a:hover { color:#928452; } .post-nav a:hover h5 { color:#928452; } .author-name a:hover { color:#928452; } .author-meta-social a:hover { background:#928452; } .logged-in-as a { color:#928452; } .comment-form input[type="text"]:focus { border-color:#928452; } .comment-form input[type="email"]:focus { border-color:#928452; } .comment-form input[type="url"]:focus { border-color:#928452; } .comment-form textarea:focus { border-color:#928452; } .comment-form input[type="submit"] { color:#928452; } .comment-form input[type="submit"] { color:#928452; } .comment-form input[type="submit"] { border-color:#928452; } .comment-form input[type="submit"]:hover { background-color:#928452; } .comment-form input[type="submit"]:hover { background-color:#928452; } .archive-nav a { color:#928452; } .archive-nav a { border:#928452; } .archive-nav a:hover { background:#928452; } .tagcloud a:hover { background:#928452; } .search-form .search-button:hover:before { color:#928452; } .widget_hoffman_recent_posts a:hover .title { color:#928452; } .widget_hoffman_recent_comments a:hover .title span { color:#928452; } .widget_hoffman_recent_posts a:hover .genericon { color:#928452; } .credits-menu a { color:#928452; } .credits .menu-social a:hover { background:#928452; } .credits p a:hover { color:#928452; } .nav-toggle.active p { color:#928452; } .nav-toggle.active .bar { background:#928452; } </style> <style type="text/css" id="custom-background-css"> body.custom-background { background-color: #f9f9f9; } </style> </head> <body class="home blog custom-background no-featured-image"> <div class="wrapper" id="wrapper"> <div class="header"> <h1 class="blog-title"> <a href="/" title="月随人 &mdash; 专注PHP,LNMP,C,Linux网站架构技术" rel="home">月随人</a> </h1> <h3 class="blog-description">专注PHP,LNMP,C,Linux网站架构技术</h3> <a class="nav-toggle" title="Click to view the navigation" href="#"> <div class="bars"> <div class="bar"></div> <div class="bar"></div> <div class="bar"></div> <div class="clear"></div> </div> <p> <span class="menu">Menu</span> <span class="close">Close</span> </p> </a> <div class="menu-social"><ul id="menu-social-items" class="menu-items"><li id="menu-item-830" class="menu-item menu-item-type-custom menu-item-object-custom current-menu-item current_page_item menu-item-home menu-item-830"><a href="/"><span class="screen-reader-text">首页</span></a></li> <li id="menu-item-713" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-713"><a href="https://github.com/kcloze"><span class="screen-reader-text">github</span></a></li> <li id="menu-item-712" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-712"><a href="//www.weibo.com/kcloze"><span class="screen-reader-text">weibo</span></a></li> </ul></div> <div class="clear"></div> </div> <div class="navigation hidden bg-dark"> <div class="section-inner"> <ul class="main-menu"> <li class="menu-item menu-item-type-custom menu-item-object-custom current-menu-item current_page_item menu-item-home menu-item-830"><a href="/">首页</a></li> <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-713"><a href="https://github.com/kcloze">github</a></li> <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-712"><a href="//www.weibo.com/kcloze">weibo</a></li> <div class="clear"></div> </ul> <ul class="mobile-menu hidden"> <li class="menu-item menu-item-type-custom menu-item-object-custom current-menu-item current_page_item menu-item-home menu-item-830"><a href="/">首页</a></li> <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-713"><a href="https://github.com/kcloze">github</a></li> <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-712"><a href="//www.weibo.com/kcloze">weibo</a></li> </ul> </div> </div> <div class="content"> <div class="posts" id="posts"> <div id="post-815" class="post-815 post type-post status-publish format-standard hentry category-mysql no-featured-image"> <div class="post-inner section-inner thin"> <div class="post-header"> <div class="post-meta top"> <a href="mysql%e5%a4%84%e7%90%86%e9%ab%98%e5%b9%b6%e5%8f%91%ef%bc%8c%e9%98%b2%e6%ad%a2%e5%ba%93%e5%ad%98%e8%b6%85%e5%8d%96/" title="mysql处理高并发，防止库存超卖">2014年12月26日</a> </div> <h2 class="post-title"><a href="mysql%e5%a4%84%e7%90%86%e9%ab%98%e5%b9%b6%e5%8f%91%ef%bc%8c%e9%98%b2%e6%ad%a2%e5%ba%93%e5%ad%98%e8%b6%85%e5%8d%96/" title="mysql处理高并发，防止库存超卖">mysql处理高并发，防止库存超卖</a></h2> </div> <div class="post-content"> <p style="font-size: 14px; margin-top: 0px; margin-bottom: 0px; padding-top: 0px; padding-bottom: 0px; color: rgb(69, 69, 69); font-family: tahoma, helvetica, arial; line-height: 21px;"> &nbsp; &nbsp; &nbsp; 抢购场景完全靠数据库来扛，压力是非常大的，我们在最近的一次抢购活动改版中，采用了redis队列+mysql事务控制的方案，画了个简单的流程图： </p> <p style="font-size: 14px; margin-top: 0px; margin-bottom: 0px; padding-top: 0px; padding-bottom: 0px; color: rgb(69, 69, 69); font-family: tahoma, helvetica, arial; line-height: 21px;"> &nbsp; </p> <p style="font-size: 14px; margin-top: 0px; margin-bottom: 0px; padding-top: 0px; padding-bottom: 0px; color: rgb(69, 69, 69); font-family: tahoma, helvetica, arial; line-height: 21px;"> <a href="wp-content/uploads/2014/12/QQ截图20141230150409.png"><img alt="QQ截图20141230150409" class="alignnone size-full wp-image-824" height="728" src="wp-content/uploads/2014/12/QQ截图20141230150409.png" width="881"/></a> </p> <p style="font-size: 14px; margin-top: 0px; margin-bottom: 0px; padding-top: 0px; padding-bottom: 0px; color: rgb(69, 69, 69); font-family: tahoma, helvetica, arial; line-height: 21px;"> &nbsp; </p> <p style="font-size: 14px; margin-top: 0px; margin-bottom: 0px; padding-top: 0px; padding-bottom: 0px; color: rgb(69, 69, 69); font-family: tahoma, helvetica, arial; line-height: 21px;"> &nbsp; </p> <p style="font-size: 14px; margin-top: 0px; margin-bottom: 0px; padding-top: 0px; padding-bottom: 0px; color: rgb(69, 69, 69); font-family: tahoma, helvetica, arial; line-height: 21px;"> &nbsp; </p> <p style="font-size: 14px; margin-top: 0px; margin-bottom: 0px; padding-top: 0px; padding-bottom: 0px; color: rgb(69, 69, 69); font-family: tahoma, helvetica, arial; line-height: 21px;"> &nbsp; &nbsp; &nbsp; &nbsp;先来就库存超卖的问题作描述：一般电子商务网站都会遇到如团购、秒杀、特价之类的活动，而这样的活动有一个共同的特点就是访问量激增、上千甚至上万人抢购一个商品。然而，作为活动商品，库存肯定是很有限的，如何控制库存不让出现超买，以防止造成不必要的损失是众多电子商务网站程序员头疼的问题，这同时也是最基本的问题。 </p> <p style="font-size: 14px; margin-top: 0px; margin-bottom: 0px; padding-top: 0px; padding-bottom: 0px; color: rgb(69, 69, 69); font-family: tahoma, helvetica, arial; line-height: 21px;"> 从技术方面剖析，很多人肯定会想到事务，但是事务是控制库存超卖的必要条件，但不是充分必要条件。 </p> <p style="font-size: 14px; margin-top: 0px; margin-bottom: 0px; padding-top: 0px; padding-bottom: 0px; color: rgb(69, 69, 69); font-family: tahoma, helvetica, arial; line-height: 21px;"> 举例： </p> <p style="font-size: 14px; margin-top: 0px; margin-bottom: 0px; padding-top: 0px; padding-bottom: 0px; color: rgb(69, 69, 69); font-family: tahoma, helvetica, arial; line-height: 21px;"> 总库存：4个商品 </p> <p style="font-size: 14px; margin-top: 0px; margin-bottom: 0px; padding-top: 0px; padding-bottom: 0px; color: rgb(69, 69, 69); font-family: tahoma, helvetica, arial; line-height: 21px;"> 请求人：a、1个商品 b、2个商品 c、3个商品 </p> <p style="font-size: 14px; margin-top: 0px; margin-bottom: 0px; padding-top: 0px; padding-bottom: 0px; color: rgb(69, 69, 69); font-family: tahoma, helvetica, arial; line-height: 21px;"> 程序如下： </p> <pre class="brush:sql;">
beginTranse(开启事务)
try{
    $result = $dbca-&gt;query(&#39;select amount from s_store where postID = 12345&#39;);
    if(result-&gt;amount &gt; 0){
        //quantity为请求减掉的库存数量
        $dbca-&gt;query(&#39;update s_store set amount = amount - quantity where postID = 12345&#39;);
    }
}catch($e Exception){
    rollBack(回滚)
}
commit(提交事务)</pre> <p style="font-size: 14px; margin-top: 0px; margin-bottom: 0px; padding-top: 0px; padding-bottom: 0px; color: rgb(69, 69, 69); font-family: tahoma, helvetica, arial; line-height: 21px;"> &nbsp; &nbsp; &nbsp; &nbsp;以上代码就是我们平时控制库存写的代码了，大多数人都会这么写，看似问题不大，其实隐藏着巨大的漏洞。数据库的访问其实就是对磁盘文件的访问，数据库中的表其实就是保存在磁盘上的一个个文件，甚至一个文件包含了多张表。例如由于高并发，当前有三个用户a、b、c三个用户进入到了这个事务中，这个时候会产生一个共享锁，所以在select的时候，这三个用户查到的库存数量都是4个，同时还要注意，mysql innodb查到的结果是有版本控制的，在其他用户更新没有commit之前(也就是没有产生新版本之前)，当前用户查到的结果依然是就版本； </p> <p style="font-size: 14px; margin-top: 0px; margin-bottom: 0px; padding-top: 0px; padding-bottom: 0px; color: rgb(69, 69, 69); font-family: tahoma, helvetica, arial; line-height: 21px;"> 然后是update，假如这三个用户同时到达update这里，这个时候update更新语句会把并发串行化，也就是给同时到达这里的是三个用户排个序，一个一个执行，并生成排他锁，在当前这个update语句commit之前，其他用户等待执行，commit后，生成新的版本；这样执行完后，库存肯定为负数了。但是根据以上描述，我们修改一下代码就不会出现超买现象了，代码如下： </p> <pre class="brush:sql;">
beginTranse(开启事务)
try{
    //quantity为请求减掉的库存数量
    $dbca-&gt;query(&#39;update s_store set amount = amount - quantity where postID = 12345&#39;);
    $result = $dbca-&gt;query(&#39;select amount from s_store where postID = 12345&#39;);
    if(result-&gt;amount &lt; 0){
       throw new Exception(&#39;库存不足&#39;);
    }
}catch($e Exception){
    rollBack(回滚)
}
commit(提交事务)</pre> <p> 通过ab工具测试了下并发请求，没有出现库存为负数的情况，说明起到了库存控制的效果。 </p> <p> 参考：<a href="//blog.csdn.net/wangsg2014/article/details/20492183">http://blog.csdn.net/wangsg2014/article/details/20492183</a> </p> <p> &nbsp;</p> </div> </div> </div> </div> <div class="archive-nav"> <div class="section-inner"> <a href="page/2/" class="post-nav-older">&laquo; Older posts</a> <div class="clear"></div> </div> </div> </div> <div class="footer"> <div class="section-inner"> <div class="column column-1 one-third"> <div class="widgets"> <div class="widget widget_categories"><div class="widget-content"><h3 class="widget-title">文章分类</h3> <ul> <li class="cat-item cat-item-2"><a href="category/technical-docs/">Docs</a> (20) </li> <li class="cat-item cat-item-3"><a href="category/go-lang/">Go</a> (1) </li> <li class="cat-item cat-item-4"><a href="category/ide/">IDE</a> (8) </li> <li class="cat-item cat-item-5"><a href="category/js-html/">Js Html</a> (11) </li> <li class="cat-item cat-item-6"><a href="category/life/">Life</a> (13) </li> <li class="cat-item cat-item-7"><a href="category/linux/">Linux</a> (21) </li> <li class="cat-item cat-item-8"><a href="category/mysql/">Mysql</a> (29) </li> <li class="cat-item cat-item-9"><a href="category/nginx/">Nginx</a> (5) </li> <li class="cat-item cat-item-10"><a href="category/nosql/">Nosql</a> (2) </li> <li class="cat-item cat-item-11"><a href="category/php/">PHP</a> (48) </li> <li class="cat-item cat-item-12"><a href="category/python/">Python</a> (2) </li> <li class="cat-item cat-item-13"><a href="category/yii-framework/">Yii</a> (8) </li> </ul> </div><div class="clear"></div></div><div class="widget widget_search"><div class="widget-content"><h3 class="widget-title">搜索</h3><form method="get" class="search-form" id="search-form" action="/"> <input type="search" class="search-field" placeholder="Search form" name="s" id="s"/> <a id="searchsubmit" class="search-button" onclick="document.getElementById('search-form').submit(); return false;"></a> </form></div><div class="clear"></div></div> </div> </div> <div class="clear"></div> </div> </div> <div class="credits"> <div class="section-inner"> <div class="menu-social"><ul id="menu-social-items" class="menu-items"><li class="menu-item menu-item-type-custom menu-item-object-custom current-menu-item current_page_item menu-item-home menu-item-830"><a href="/"><span class="screen-reader-text">首页</span></a></li> <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-713"><a href="https://github.com/kcloze"><span class="screen-reader-text">github</span></a></li> <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-712"><a href="//www.weibo.com/kcloze"><span class="screen-reader-text">weibo</span></a></li> </ul></div> <div class="fleft"> <ul class="credits-menu"> <li class="menu-item menu-item-type-custom menu-item-object-custom current-menu-item current_page_item menu-item-home menu-item-830"><a href="/">首页</a></li> <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-713"><a href="https://github.com/kcloze">github</a></li> <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-712"><a href="//www.weibo.com/kcloze">weibo</a></li> <div class="clear"></div> </ul> <p>&copy; 2015 <a href="/" title="月随人">月随人</a>. All rights reserved.</p> <p>Theme by <a href="//www.andersnoren.se/">Anders Nor&eacute;n</a>.</p> </div> <div class="clear"></div> </div> </div> <div id="su-footer-links" style="text-align: center;"></div><script type='text/javascript' src='http://kcloze.qiniudn.com/wp-content/themes/hoffman/js/flexslider.min.js?ver=4.1'></script> <script type='text/javascript' src='http://kcloze.qiniudn.com/wp-content/themes/hoffman/js/global.js?ver=4.1'></script> </body> </html>
<!-- Dynamic page generated in 0.124 seconds. -->
<!-- Cached page generated by WP-Super-Cache on 2015-01-11 13:01:24 -->

<!-- super cache -->